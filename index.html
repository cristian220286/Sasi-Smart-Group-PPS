<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sasi Smart Group PPS (Tiempo Real)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .table-header th { padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.05em; background-color: #f9fafb; position: sticky; top: 0; z-index: 10; }
        .table-cell { padding: 0.75rem 1rem; font-size: 0.875rem; color: #1f2937; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; }
        .badge-faltante { background-color: #fee2e2; color: #b91c1c; }
        .badge-sobrante { background-color: #dcfce7; color: #166534; }
        .badge-cuadrado { background-color: #e0e7ff; color: #3730a3; }
        .badge-pendiente { background-color: #fef3c7; color: #92400e; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .input-field { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px #c7d2fe; }
        #toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; font-weight: 600; z-index: 9999; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(-20px); }
        #toast.show { opacity: 1; transform: translateY(0); }
        #toast.success { background-color: #22c55e; }
        #toast.error { background-color: #ef4444; }
        /* Estilos para el modal */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; /* Permanece en su lugar */
            z-index: 10000; /* Se superpone a todo */
            left: 0;
            top: 0;
            width: 100%; /* Ancho completo */
            height: 100%; /* Alto completo */
            overflow: auto; /* Habilitar scroll si es necesario */
            background-color: rgba(0,0,0,0.4); /* Fondo semi-transparente */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Estilos para la sección de autenticación */
        #auth-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 2rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-width: 400px;
            margin: 50px auto;
        }
        #auth-section h2 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 1rem;
        }
        #app-content {
            display: none; /* Oculto por defecto hasta que el usuario inicie sesión */
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div id="toast"></div>

    <!-- Modal para mensajes de confirmación/alerta -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message" class="text-lg font-semibold mb-4"></p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <!-- Los botones se insertarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Sasi Smart Group PPS (Tiempo Real)</h1>
                <p class="text-gray-600 mt-1">Gestión a gran escala con Auditoría en Google Drive y datos en tiempo real.</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="btn-limpiar-datos" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i>Limpiar Datos Locales</button>
                <button id="btn-logout" class="btn btn-secondary"><i class="fa-solid fa-right-from-bracket"></i>Cerrar Sesión</button>
            </div>
            <div class="text-gray-600">
                ID de Usuario: <span id="user-id-display" class="font-semibold text-indigo-700">Cargando...</span>
            </div>
        </header>

        <!-- Sección de Autenticación -->
        <div id="auth-section">
            <h2>Iniciar Sesión / Registrarse</h2>
            <input type="email" id="auth-email" class="input-field" placeholder="Correo Electrónico" required>
            <input type="password" id="auth-password" class="input-field" placeholder="Contraseña" required>
            <button id="btn-login" class="btn btn-primary">Iniciar Sesión</button>
            <button id="btn-register" class="btn btn-secondary">Registrarse</button>
        </div>

        <!-- Contenido Principal de la Aplicación (Oculto hasta iniciar sesión) -->
        <div id="app-content">
            <!-- Sección de Entradas de Datos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Cargar Catálogo (CSV)</h2>
                    <p class="text-sm text-gray-500 mb-4">Cargue su stock teórico. El archivo debe ser CSV con <strong>punto y coma (;)</strong> como separador. El sistema ignorará la cabecera.</p>
                    <input type="file" id="csv-file-input" accept=".csv" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">2. Registrar Venta</h2>
                    <form id="form-ventas">
                        <div class="space-y-4">
                            <input type="text" id="venta-sku" class="input-field" placeholder="SKU del Producto" required>
                            <input type="number" id="venta-cantidad" class="input-field" placeholder="Cantidad Vendida" required min="1">
                            <button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-cart-shopping"></i>Registrar</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">3. Añadir al Conteo</h2>
                    <form id="form-conteo">
                        <div class="space-y-4">
                            <input type="text" id="conteo-sku" class="input-field" placeholder="SKU del Producto" required>
                            <input type="number" id="conteo-cantidad" class="input-field" placeholder="Cantidad a AÑADIR" required min="1">
                            <button type="submit" class="btn btn-primary w-full"><i class="fa-solid fa-plus"></i>Añadir</button>
                        </div>
                    </form>
                </div>
                <div class="card border-2 border-amber-400 bg-amber-50">
                    <h2 class="text-xl font-semibold mb-4 text-amber-800"><i class="fa-solid fa-shield-halved"></i> 4. Corregir Stock</h2>
                    <form id="form-correccion">
                        <div class="space-y-4">
                            <input type="text" id="correc-sku" class="input-field" placeholder="SKU a corregir" required>
                            <input type="number" id="correc-cantidad" class="input-field" placeholder="Nuevo Stock Físico TOTAL" required min="0">
                            <input type="email" id="correc-email" class="input-field" placeholder="Su Email para auditoría" required>
                            <input type="password" id="correc-codigo" class="input-field" placeholder="Código de Autorización" required>
                            <button type="submit" class="btn btn-primary w-full bg-amber-600 hover:bg-amber-700"><i class="fa-solid fa-pen-to-square"></i>Corregir</button>
                        </div>
                    </form>
                </div>
                <div class="card border-2 border-rose-400 bg-rose-50">
                    <h2 class="text-xl font-semibold mb-4 text-rose-800"><i class="fa-solid fa-undo"></i> 5. Anular Venta</h2>
                    <form id="form-anulacion">
                        <div class="space-y-4">
                            <input type="text" id="anular-sku" class="input-field" placeholder="SKU de la venta a anular" required>
                            <input type="number" id="anular-cantidad" class="input-field" placeholder="Cantidad a anular" required min="1">
                            <input type="email" id="anular-email" class="input-field" placeholder="Su Email para auditoría" required>
                            <input type="password" id="anular-codigo" class="input-field" placeholder="Código de Autorización" required>
                            <button type="submit" class="btn btn-primary w-full bg-rose-600 hover:bg-rose-700"><i class="fa-solid fa-eraser"></i>Anular</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dashboard de Reconciliación -->
            <div class="card">
                <div class="flex justify-between items-center mb-4 gap-4 flex-wrap">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard de Reconciliación</h2>
                    <div class="flex gap-4 items-center">
                        <input type="text" id="search-input" placeholder="Buscar por SKU o Descripción..." class="input-field w-full max-w-xs">
                        <button id="btn-descargar-csv" class="btn btn-secondary"><i class="fa-solid fa-file-csv"></i>Descargar CSV</button>
                    </div>
                </div>
                <div class="overflow-x-auto max-h-[65vh]">
                    <table class="w-full">
                        <thead class="table-header">
                            <tr>
                                <th>Prioridad</th><th>SKU</th><th>Estado</th><th>Dif. Auditoría</th><th>Dif. Conteo vs Teórico</th><th>Stock Final Real</th><th>Stock Teórico</th><th>Físico Contado</th><th>Total Vendido</th><th>Fecha Conteo</th><th>Fecha Venta</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, query, orderBy, serverTimestamp, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        // DEBES REEMPLAZAR ESTO CON TU PROPIA CONFIGURACIÓN DE FIREBASE
       const firebaseConfig = {
  apiKey: "AIzaSyAzGc3KVQFYIoQ7W_WZAj585AbUpiU5HUI",
  authDomain: "sasi-alfa-store-pps.firebaseapp.com",
  projectId: "sasi-alfa-store-pps",
  storageBucket: "sasi-alfa-store-pps.firebasestorage.app",
  messagingSenderId: "739926676625",
  appId: "1:739926676625:web:b4ff509e304f980ff71b30"
};

        // --- CONFIGURACIÓN ESPECÍFICA DEL NEGOCIO ---
        // ¡IMPORTANTE! DEBES CAMBIAR ESTO PARA CADA ARCHIVO HTML DUPLICADO
        // Por ejemplo: 'sasi-alfa-sucursal-centro', 'sasi-alfa-sucursal-norte', etc.
        const BUSINESS_ID = 'Sasi Smart Group PPS'; 
        // Asegúrate de que este ID sea único para cada negocio y que coincida con tus reglas de seguridad.

        // --- CONFIGURACIÓN DE GOOGLE APPS SCRIPT PARA AUDITORÍA (SI APLICAS) ---
        // Si mantienes el script de auditoría en Google Sheets, pega aquí su nueva URL de despliegue
        // que permita CORS (normalmente un despliegue de tipo "Web app" con acceso "Anyone").
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxTSp1A7tIl4sVus6RXkbONCPkGmrvjQVRplg8ul9agoMa7ZmSBogrNpW_Al7Q3l8kYUA/exec'; // Reemplaza con tu URL real

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Referencias a colecciones de Firestore (ahora anidadas bajo el ID del negocio)
        let stockTeoricoCol;
        let datosVentasCol;
        let datosConteoCol;
        let usersCol = collection(db, "users"); // Colección para perfiles de usuario

        // Variables globales para los datos y el ID de usuario
        let stockTeorico = [];
        let datosVentas = [];
        let datosConteo = [];
        let userId = null; // Será el UID de Firebase del usuario autenticado
        let userEmail = null; // Email del usuario autenticado

        // --- REFERENCIAS UI ---
        const formVentas = document.getElementById('form-ventas');
        const formConteo = document.getElementById('form-conteo');
        const formCorreccion = document.getElementById('form-correccion');
        const formAnulacion = document.getElementById('form-anulacion');
        const dashboardBody = document.getElementById('dashboard-body');
        const csvFileInput = document.getElementById('csv-file-input');
        const btnLimpiarDatos = document.getElementById('btn-limpiar-datos');
        const btnDescargarCSV = document.getElementById('btn-descargar-csv');
        const toastElement = document.getElementById('toast');
        const searchInput = document.getElementById('search-input');
        const userIdDisplay = document.getElementById('user-id-display');
        const authSection = document.getElementById('auth-section');
        const appContent = document.getElementById('app-content');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const btnLogin = document.getElementById('btn-login');
        const btnRegister = document.getElementById('btn-register');
        const btnLogout = document.getElementById('btn-logout');


        // Modal elements
        const myModal = document.getElementById('myModal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');
        const closeButton = document.querySelector('.close-button');

        // Función para mostrar el modal
        function showModal(message, type = 'alert', onConfirm = null, onCancel = null) {
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // Limpiar botones anteriores

            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirmar';
                confirmBtn.className = 'btn btn-primary';
                confirmBtn.onclick = () => {
                    myModal.style.display = 'none';
                    if (onConfirm) onConfirm();
                };
                modalButtons.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancelar';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.onclick = () => {
                    myModal.style.display = 'none';
                    if (onCancel) onCancel();
                };
                modalButtons.appendChild(cancelBtn);
            } else { // type === 'alert'
                const okBtn = document.createElement('button');
                okBtn.textContent = 'Aceptar';
                okBtn.className = 'btn btn-primary';
                okBtn.onclick = () => {
                    myModal.style.display = 'none';
                    if (onConfirm) onConfirm(); // Usar onConfirm como callback de "OK"
                };
                modalButtons.appendChild(okBtn);
            }
            myModal.style.display = 'flex'; // Mostrar el modal
        }

        // Cerrar modal al hacer clic en la 'x'
        closeButton.onclick = () => {
            myModal.style.display = 'none';
        };

        // Cerrar modal al hacer clic fuera del contenido
        window.onclick = (event) => {
            if (event.target == myModal) {
                myModal.style.display = 'none';
            }
        };

        // Reemplazo de showToast para usar el modal en errores críticos
        function showToast(message, type = 'success') {
            toastElement.textContent = message;
            toastElement.className = ``;
            toastElement.classList.add('show', type);
            setTimeout(() => { toastElement.classList.remove('show'); }, 3000);
        }

        function normalizarSku(sku) { return sku.toUpperCase().trim(); }

        // --- FUNCIONES DE AUTENTICACIÓN ---

        btnLogin.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Sesión iniciada correctamente.');
                // onAuthStateChanged manejará la visibilidad del contenido
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                let errorMessage = 'Error al iniciar sesión. Por favor, verifique sus credenciales.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado. ¿Se ha registrado?';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contraseña incorrecta.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Formato de correo electrónico inválido.';
                }
                showModal(errorMessage, 'error');
            }
        });

        btnRegister.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Guardar el perfil del usuario con el businessId
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: email,
                    businessId: BUSINESS_ID, // Asigna el ID de negocio a este usuario
                    createdAt: serverTimestamp()
                });
                showToast('Usuario registrado y sesión iniciada correctamente.');
                // onAuthStateChanged manejará la visibilidad del contenido
            } catch (error) {
                console.error("Error al registrar usuario:", error);
                let errorMessage = 'Error al registrar usuario. Inténtelo de nuevo.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'El correo electrónico ya está en uso.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Formato de correo electrónico inválido.';
                }
                showModal(errorMessage, 'error');
            }
        });

        btnLogout.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Sesión cerrada correctamente.');
                // onAuthStateChanged manejará la visibilidad del contenido
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                showModal('Error al cerrar sesión. Inténtelo de nuevo.', 'error');
            }
        });

        // --- FUNCIONES DE CARGA Y REGISTRO DE DATOS (AHORA CON FIRESTORE) ---

        // Carga inicial del catálogo desde CSV y lo guarda en Firestore
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('Cargando catálogo, por favor espere...', 'info');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const rows = text.split('\n').filter(row => row.trim() !== '').slice(1);
                try {
                    const nuevosProductos = rows.map(row => {
                        const columns = row.split(';');
                        if (columns.length < 3) throw new Error(`Fila inválida: ${row}`);
                        const sku = normalizarSku(columns[0]);
                        const stock = parseInt(columns[2], 10);
                        if (isNaN(stock)) throw new Error(`Stock inválido para SKU ${sku}`);
                        return { sku, descripcion: columns[1].trim(), stock };
                    });

                    // Eliminar todos los documentos existentes en stockTeorico antes de añadir los nuevos
                    const existingDocs = await getDocs(stockTeoricoCol);
                    const batch = writeBatch(db); // Usar batch para operaciones atómicas

                    existingDocs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Añadir los nuevos productos
                    for (const prod of nuevosProductos) {
                        const docRef = doc(stockTeoricoCol, prod.sku); // Usar SKU como ID del documento
                        batch.set(docRef, prod);
                    }
                    await batch.commit(); // Ejecutar el batch

                    showToast(`Catálogo cargado con ${nuevosProductos.length} productos en la base de datos.`, 'success');
                    csvFileInput.value = ''; // Limpiar el input de archivo
                } catch (error) {
                    showToast(`Error al procesar CSV: ${error.message}`, 'error');
                    console.error("Error al cargar CSV a Firestore:", error);
                }
            };
            reader.readAsText(file);
        }

        // Registrar Venta en Firestore
        async function registrarVenta(event) {
            event.preventDefault();
            const skuInput = document.getElementById('venta-sku');
            const cantidadInput = document.getElementById('venta-cantidad');
            const sku = normalizarSku(skuInput.value);
            const cantidad = parseInt(cantidadInput.value, 10);

            if (!stockTeorico.some(p => p.sku === sku)) {
                showModal('Error: El SKU no existe en el catálogo.', 'alert');
                return;
            }

            try {
                await addDoc(datosVentasCol, {
                    timestamp: serverTimestamp(), // Marca de tiempo del servidor
                    sku: sku,
                    cantidad: cantidad,
                    userId: userId,
                    businessId: BUSINESS_ID
                });
                showToast('Venta registrada correctamente en la base de datos.');
                formVentas.reset();
                skuInput.focus();
            } catch (error) {
                console.error("Error al registrar venta en Firestore:", error);
                showModal('Error al registrar la venta. Inténtelo de nuevo.', 'error');
            }
        }

        // Añadir al Conteo en Firestore
        async function anadirAlConteo(event) {
            event.preventDefault();
            const skuInput = document.getElementById('conteo-sku');
            const cantidadInput = document.getElementById('conteo-cantidad');
            const sku = normalizarSku(skuInput.value);
            const cantidad = parseInt(cantidadInput.value, 10);

            if (!stockTeorico.some(p => p.sku === sku)) {
                showModal('Error: El SKU no existe en el catálogo.', 'alert');
                return;
            }

            try {
                await addDoc(datosConteoCol, {
                    timestamp: serverTimestamp(), // Marca de tiempo del servidor
                    sku: sku,
                    cantidad: cantidad,
                    tipo: 'conteo',
                    userId: userId,
                    businessId: BUSINESS_ID
                });
                showToast('Cantidad añadida al conteo en la base de datos.');
                formConteo.reset();
                skuInput.focus();
            } catch (error) {
                console.error("Error al añadir conteo en Firestore:", error);
                showModal('Error al añadir al conteo. Inténtelo de nuevo.', 'error');
            }
        }

        // Función para enviar datos a Google Apps Script (auditoría)
        async function sendToAudit(logData) {
            if (GOOGLE_SCRIPT_URL === 'URL_A_REEMPLAZAR') {
                showToast('Error: La URL del script de Google no está configurada para auditoría.', 'error');
                return false;
            }
            try {
                // Modo 'cors' necesario para comunicación directa con Apps Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logData)
                });
                const result = await response.json(); // Asume que el script devuelve JSON
                if (result.result === "success") {
                    showToast('Operación enviada a auditoría correctamente.');
                    return true;
                } else {
                    console.error('Error en la respuesta de auditoría:', result.error);
                    showModal('Error al enviar a auditoría: ' + result.error, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error enviando a Google Sheets para auditoría:', error);
                showModal('Error al enviar a auditoría. Ver consola.', 'error');
                return false;
            }
        }

        // Corregir Conteo en Firestore y enviar a auditoría
        async function corregirConteo(event) {
            event.preventDefault();
            const skuInput = document.getElementById('correc-sku');
            const cantidadInput = document.getElementById('correc-cantidad');
            const emailInput = document.getElementById('correc-email');
            const codigoInput = document.getElementById('correc-codigo');

            if (codigoInput.value !== '10234567') {
                showModal('Error: Código de autorización incorrecto.', 'alert');
                return;
            }
            const sku = normalizarSku(skuInput.value);
            if (!stockTeorico.some(p => p.sku === sku)) {
                showModal('Error: El SKU no existe en el catálogo.', 'alert');
                return;
            }
            const fisicoContadoActual = calcularFisicoContado(sku);
            const nuevaCantidadTotal = parseInt(cantidadInput.value, 10);

            const logData = {
                tipo: 'Corrección de Stock',
                timestamp: new Date().toISOString(),
                sku,
                email: emailInput.value,
                cantidadAnterior: fisicoContadoActual,
                cantidadNueva: nuevaCantidadTotal,
                userId: userId,
                businessId: BUSINESS_ID
            };

            // Primero, enviar a auditoría
            const auditSuccess = await sendToAudit(logData);
            if (!auditSuccess) return;

            // Si la auditoría fue exitosa, registrar en Firestore
            try {
                await addDoc(datosConteoCol, {
                    timestamp: serverTimestamp(),
                    sku,
                    cantidad: nuevaCantidadTotal,
                    tipo: 'modificacion',
                    email: emailInput.value,
                    userId: userId,
                    businessId: BUSINESS_ID
                });
                showToast('Stock corregido y registrado en la base de datos.');
                formCorreccion.reset();
            } catch (error) {
                console.error("Error al corregir conteo en Firestore:", error);
                showModal('Error al corregir el stock. Inténtelo de nuevo.', 'error');
            }
        }

        // Anular Venta en Firestore y enviar a auditoría
        async function anularVenta(event) {
            event.preventDefault();
            const skuInput = document.getElementById('anular-sku');
            const cantidadInput = document.getElementById('anular-cantidad');
            const emailInput = document.getElementById('anular-email');
            const codigoInput = document.getElementById('anular-codigo');

            if (codigoInput.value !== '10234567') {
                showModal('Error: Código de autorización incorrecto.', 'alert');
                return;
            }
            const sku = normalizarSku(skuInput.value);
            if (!stockTeorico.some(p => p.sku === sku)) {
                showModal('Error: El SKU no existe en el catálogo.', 'alert');
                return;
            }
            const cantidadAnular = parseInt(cantidadInput.value, 10);

            const logData = {
                tipo: 'Anulación de Venta',
                timestamp: new Date().toISOString(),
                sku,
                email: emailInput.value,
                cantidadAnterior: `N/A (Anulación de ${cantidadAnular})`,
                cantidadNueva: -cantidadAnular,
                userId: userId,
                businessId: BUSINESS_ID
            };

            // Primero, enviar a auditoría
            const auditSuccess = await sendToAudit(logData);
            if (!auditSuccess) return;

            // Si la auditoría fue exitosa, registrar en Firestore
            try {
                await addDoc(datosVentasCol, {
                    timestamp: serverTimestamp(),
                    sku,
                    cantidad: -cantidadAnular, // Registrar como cantidad negativa
                    userId: userId,
                    businessId: BUSINESS_ID
                });
                showToast('Venta anulada y registrada en la base de datos.');
                formAnulacion.reset();
            } catch (error) {
                console.error("Error al anular venta en Firestore:", error);
                showModal('Error al anular la venta. Inténtelo de nuevo.', 'error');
            }
        }

        // --- FUNCIONES PRINCIPALES DE CÁLCULO Y RENDERIZADO ---
        function calcularFisicoContado(sku) {
            const conteosSKU = datosConteo.filter(c => c.sku === sku);
            if (conteosSKU.length === 0) return 0;

            let ultimoIndiceModificacion = -1;
            for (let i = conteosSKU.length - 1; i >= 0; i--) {
                if (conteosSKU[i].tipo === 'modificacion') {
                    ultimoIndiceModificacion = i;
                    break;
                }
            }

            if (ultimoIndiceModificacion !== -1) {
                let stockBase = conteosSKU[ultimoIndiceModificacion].cantidad;
                for (let i = ultimoIndiceModificacion + 1; i < conteosSKU.length; i++) {
                    if (conteosSKU[i].tipo === 'conteo') {
                        stockBase += conteosSKU[i].cantidad;
                    }
                }
                return stockBase;
            } else {
                return conteosSKU.reduce((total, c) => total + c.cantidad, 0);
            }
        }

        function getDashboardData() {
            const searchTerm = searchInput.value.toUpperCase().trim();
            let motorCalculos = stockTeorico.map(producto => {
                const sku = producto.sku;
                const fisicoContado = calcularFisicoContado(sku);
                const ventasFiltradas = datosVentas.filter(v => v.sku === sku);
                const agregadoVentas = {
                    total: ventasFiltradas.reduce((sum, v) => sum + v.cantidad, 0),
                    ultimaVenta: ventasFiltradas.length > 0 ? new Date(Math.max(...ventasFiltradas.map(v => v.timestamp ? v.timestamp.toDate().getTime() : 0))) : null
                };
                const conteosFiltrados = datosConteo.filter(c => c.sku === sku);
                const ultimoConteoTimestamp = conteosFiltrados.length > 0 ? new Date(Math.max(...conteosFiltrados.map(c => c.timestamp ? c.timestamp.toDate().getTime() : 0))) : null;

                const stockTeoricoInicial = producto.stock;
                const ventas = agregadoVentas.total;
                const horaConteo = ultimoConteoTimestamp;
                const horaVenta = agregadoVentas.ultimaVenta;

                let stockFinalCalculado;
                if (!horaConteo) {
                    stockFinalCalculado = stockTeoricoInicial - ventas;
                } else if (horaVenta && horaVenta > horaConteo) {
                    stockFinalCalculado = fisicoContado - ventas;
                } else {
                    stockFinalCalculado = stockTeoricoInicial - ventas;
                }

                let diferenciaAuditoria = horaConteo ? stockFinalCalculado - (stockTeoricoInicial - ventas) : 0;
                let diferenciaConteoDirecta = horaConteo ? fisicoContado - stockTeoricoInicial : 'N/A';

                let estadoCalculado, prioridad;
                if (!horaConteo) {
                    estadoCalculado = 'Pendiente';
                    prioridad = 3;
                } else if (diferenciaAuditoria === 0) {
                    estadoCalculado = 'Cuadrado';
                    prioridad = 4;
                } else if (diferenciaAuditoria > 0) {
                    estadoCalculado = 'Sobrante';
                    prioridad = 2;
                } else {
                    estadoCalculado = 'Faltante';
                    prioridad = 1;
                }

                return { sku, descripcion: producto.descripcion, stockTeorico: stockTeoricoInicial, fisicoContado, ventas, horaConteo, horaVenta, diferenciaAuditoria, diferenciaConteoDirecta, stockFinalCalculado, estadoCalculado, prioridad };
            });

            if (searchTerm) {
                motorCalculos = motorCalculos.filter(item =>
                    item.sku.toUpperCase().includes(searchTerm) ||
                    item.descripcion.toUpperCase().includes(searchTerm)
                );
            }

            motorCalculos.sort((a, b) => {
                if (a.prioridad !== b.prioridad) return a.prioridad - b.prioridad;
                return a.diferenciaAuditoria - b.diferenciaAuditoria;
            });

            return motorCalculos;
        }

        function renderDashboard() {
            const motorCalculos = getDashboardData();
            const formatFecha = (fecha) => !fecha ? 'N/A' : fecha.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });
            let rowsHtml = '';

            motorCalculos.forEach(item => {
                const estadoClass = `badge-${item.estadoCalculado.toLowerCase()}`;
                const difAuditoriaClass = item.diferenciaAuditoria < 0 ? 'text-red-600' : (item.diferenciaAuditoria > 0 ? 'text-green-600' : '');
                const difDirectaClass = typeof item.diferenciaConteoDirecta === 'number' && item.diferenciaConteoDirecta < 0 ? 'text-red-600' : (typeof item.diferenciaConteoDirecta === 'number' && item.diferenciaConteoDirecta > 0 ? 'text-green-600' : '');

                rowsHtml += `<tr>
                    <td class="table-cell font-bold text-center">${item.prioridad}</td>
                    <td class="table-cell font-semibold text-indigo-700">${item.sku}</td>
                    <td class="table-cell"><span class="badge ${estadoClass}">${item.estadoCalculado}</span></td>
                    <td class="table-cell font-semibold ${difAuditoriaClass}">${item.diferenciaAuditoria}</td>
                    <td class="table-cell font-semibold ${difDirectaClass}">${item.diferenciaConteoDirecta}</td>
                    <td class="table-cell font-bold text-lg">${item.stockFinalCalculado}</td>
                    <td class="table-cell">${item.stockTeorico}</td>
                    <td class="table-cell">${item.horaConteo ? item.fisicoContado : 'N/A'}</td>
                    <td class="table-cell">${item.ventas}</td>
                    <td class="table-cell text-sm">${formatFecha(item.horaConteo)}</td>
                    <td class="table-cell text-sm">${formatFecha(item.horaVenta)}</td>
                </tr>`;
            });
            dashboardBody.innerHTML = rowsHtml;
        }

        function descargarCSV() {
            const data = getDashboardData();
            const headers = ["Prioridad", "SKU", "Descripción", "Estado", "Dif. Auditoría", "Dif. Conteo vs Teórico", "Stock Final Real", "Stock Teórico", "Físico Contado", "Total Vendido", "Fecha Conteo", "Fecha Venta"];
            let csvContent = headers.join(";") + "\n";

            data.forEach(item => {
                const row = [
                    item.prioridad,
                    item.sku,
                    `"${item.descripcion.replace(/"/g, '""')}"`, // Escapar comillas dobles en la descripción
                    item.estadoCalculado,
                    item.diferenciaAuditoria,
                    item.diferenciaConteoDirecta,
                    item.stockFinalCalculado,
                    item.stockTeorico,
                    item.horaConteo ? item.fisicoContado : 'N/A',
                    item.ventas,
                    item.horaConteo ? item.horaConteo.toLocaleString('es-AR') : 'N/A',
                    item.horaVenta ? item.horaVenta.toLocaleString('es-AR') : 'N/A'
                ];
                csvContent += row.join(";") + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "balance_inventario.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- INICIALIZACIÓN Y LISTENERS DE EVENTOS ---
        // Autenticación con Firebase
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userEmail = user.email;
                userIdDisplay.textContent = userEmail || userId; // Mostrar email si existe, sino UID
                
                // Verificar que el usuario pertenece a este negocio
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDocs(userDocRef); // Usar getDocs para un query, aunque aquí es un doc específico

                if (userDoc.exists() && userDoc.data().businessId === BUSINESS_ID) {
                    // Si el usuario está autenticado y pertenece a este negocio, mostrar la app
                    authSection.style.display = 'none';
                    appContent.style.display = 'block';

                    // Inicializar las referencias a las colecciones del negocio
                    stockTeoricoCol = collection(db, `businesses/${BUSINESS_ID}/stockTeorico`);
                    datosVentasCol = collection(db, `businesses/${BUSINESS_ID}/datosVentas`);
                    datosConteoCol = collection(db, `businesses/${BUSINESS_ID}/datosConteo`);

                    // Una vez autenticado y validado el negocio, iniciar los listeners de Firestore
                    setupFirestoreListeners();
                } else {
                    // Si el usuario no pertenece a este negocio o el perfil no existe, cerrar sesión
                    await signOut(auth);
                    showModal('Acceso denegado. Este usuario no está asociado con este negocio o su perfil no existe. Por favor, regístrese o inicie sesión con las credenciales correctas.', 'error');
                    authSection.style.display = 'flex';
                    appContent.style.display = 'none';
                    userIdDisplay.textContent = 'No autenticado';
                }

            } else {
                // Si no hay usuario, mostrar la sección de autenticación y ocultar la app
                userId = null;
                userEmail = null;
                userIdDisplay.textContent = 'No autenticado';
                authSection.style.display = 'flex';
                appContent.style.display = 'none';
                // Limpiar inputs de auth
                authEmailInput.value = '';
                authPasswordInput.value = '';
            }
        });

        // Configurar listeners de Firestore para sincronización en tiempo real
        function setupFirestoreListeners() {
            // Listener para stockTeorico
            onSnapshot(stockTeoricoCol, (snapshot) => {
                stockTeorico = snapshot.docs.map(doc => doc.data());
                renderDashboard();
                console.log("Stock Teórico actualizado desde Firestore.");
            }, (error) => {
                console.error("Error al escuchar stockTeorico:", error);
                showModal("Error al cargar el catálogo de productos. Ver consola.", 'error');
            });

            // Listener para datosVentas (ordenado por timestamp para consistencia)
            const qVentas = query(datosVentasCol, orderBy("timestamp"));
            onSnapshot(qVentas, (snapshot) => {
                datosVentas = snapshot.docs.map(doc => doc.data());
                renderDashboard();
                console.log("Datos de Ventas actualizados desde Firestore.");
            }, (error) => {
                console.error("Error al escuchar datosVentas:", error);
                showModal("Error al cargar los datos de ventas. Ver consola.", 'error');
            });

            // Listener para datosConteo (ordenado por timestamp para consistencia)
            const qConteo = query(datosConteoCol, orderBy("timestamp"));
            onSnapshot(qConteo, (snapshot) => {
                datosConteo = snapshot.docs.map(doc => doc.data());
                renderDashboard();
                console.log("Datos de Conteo actualizados desde Firestore.");
            }, (error) => {
                console.error("Error al escuchar datosConteo:", error);
                showModal("Error al cargar los datos de conteo. Ver consola.", 'error');
            });
        }

        // Event listeners para los formularios y botones
        csvFileInput.addEventListener('change', handleFileUpload);
        formVentas.addEventListener('submit', registrarVenta);
        formConteo.addEventListener('submit', anadirAlConteo);
        formCorreccion.addEventListener('submit', corregirConteo);
        formAnulacion.addEventListener('submit', anularVenta);
        btnLimpiarDatos.addEventListener('click', () => {
             showModal('¿Estás seguro de que quieres limpiar TODOS los datos locales? Esto no afectará los datos en la base de datos central.', 'confirm', () => {
                localStorage.clear();
                stockTeorico = []; datosVentas = []; datosConteo = [];
                renderDashboard();
                showToast('Todos los datos locales han sido borrados.');
             });
        });
        searchInput.addEventListener('input', renderDashboard);
        btnDescargarCSV.addEventListener('click', descargarCSV);

        // No es necesario loadData() ni renderDashboard() en window.onload,
        // ya que los listeners de Firestore se encargarán de cargar y renderizar
        // una vez que la autenticación esté lista.
    </script>
</body>
</html>
